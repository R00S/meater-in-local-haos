<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Kitchen Cooking Engine</title>
  <style>
    :root {
      --primary-color: #03a9f4;
      --primary-dark: #0288d1;
      --accent-color: #ff5722;
      --text-primary: #212121;
      --text-secondary: #757575;
      --divider-color: #e0e0e0;
      --background-color: #fafafa;
      --card-background: #ffffff;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --error-color: #f44336;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--background-color);
      color: var(--text-primary);
      min-height: 100vh;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--divider-color);
    }
    
    .header-icon {
      font-size: 32px;
      margin-right: 16px;
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 500;
    }
    
    .card {
      background: var(--card-background);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
    }
    
    .card-title .icon {
      margin-right: 8px;
    }
    
    .status-banner {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      text-align: center;
    }
    
    .status-banner.idle {
      background: var(--divider-color);
      color: var(--text-secondary);
    }
    
    .status-banner.cooking {
      background: var(--accent-color);
      color: white;
    }
    
    .status-banner.approaching {
      background: var(--warning-color);
      color: white;
    }
    
    .status-banner.goal_reached {
      background: var(--success-color);
      color: white;
    }
    
    .status-banner.resting {
      background: var(--primary-color);
      color: white;
    }
    
    .status-banner h2 {
      font-size: 20px;
      margin-bottom: 4px;
      text-transform: capitalize;
    }
    
    .status-banner p {
      opacity: 0.9;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }
    
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .button-group button {
      padding: 10px 20px;
      border: 2px solid var(--divider-color);
      border-radius: 24px;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .button-group button:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }
    
    .button-group button.selected {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }
    
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--divider-color);
      border-radius: 8px;
      font-size: 16px;
      background: white;
      cursor: pointer;
    }
    
    select:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    .doneness-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
    }
    
    .doneness-btn {
      padding: 16px 12px;
      border: 2px solid var(--divider-color);
      border-radius: 12px;
      background: white;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    
    .doneness-btn:hover {
      border-color: var(--primary-color);
    }
    
    .doneness-btn.selected {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }
    
    .doneness-btn .icon {
      font-size: 24px;
      display: block;
      margin-bottom: 4px;
    }
    
    .doneness-btn .label {
      font-size: 13px;
      font-weight: 500;
    }
    
    .method-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
    }
    
    .method-btn {
      padding: 12px 8px;
      border: 2px solid var(--divider-color);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      text-align: center;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .method-btn:hover {
      border-color: var(--primary-color);
    }
    
    .method-btn.selected {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }
    
    .action-button {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 16px;
    }
    
    .action-button.primary {
      background: var(--accent-color);
      color: white;
    }
    
    .action-button.primary:hover {
      background: #e64a19;
    }
    
    .action-button.primary:disabled {
      background: var(--divider-color);
      color: var(--text-secondary);
      cursor: not-allowed;
    }
    
    .action-button.danger {
      background: var(--error-color);
      color: white;
    }
    
    .action-button.success {
      background: var(--success-color);
      color: white;
    }
    
    .action-button.secondary {
      background: var(--primary-color);
      color: white;
    }
    
    .progress-section {
      margin: 24px 0;
    }
    
    .progress-bar-container {
      height: 12px;
      background: var(--divider-color);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-bar {
      height: 100%;
      background: var(--primary-color);
      transition: width 0.5s ease;
    }
    
    .progress-bar.approaching {
      background: var(--warning-color);
    }
    
    .progress-bar.goal_reached {
      background: var(--success-color);
    }
    
    .temp-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .temp-current {
      font-size: 36px;
      font-weight: 600;
      color: var(--accent-color);
    }
    
    .temp-target {
      font-size: 18px;
      color: var(--text-secondary);
    }
    
    .cook-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    
    .cook-info-item {
      text-align: center;
      padding: 12px;
      background: var(--background-color);
      border-radius: 8px;
    }
    
    .cook-info-item .label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    
    .cook-info-item .value {
      font-size: 16px;
      font-weight: 500;
    }
    
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    
    .action-buttons button {
      flex: 1;
    }
    
    .loading {
      text-align: center;
      padding: 48px;
      color: var(--text-secondary);
    }
    
    .error {
      background: #ffebee;
      color: var(--error-color);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    
    .entity-selector {
      margin-bottom: 24px;
      padding: 16px;
      background: var(--background-color);
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <span class="header-icon">üç≥</span>
      <h1>Kitchen Cooking Engine</h1>
    </div>
    
    <div id="app">
      <div class="loading">Loading...</div>
    </div>
  </div>

  <script>
    // Kitchen Cooking Engine Panel
    const CUTS_DATA = {
      beef: {
        name: "ü•© Beef",
        cuts: [
          { id: 100, name: "Ribeye Steak" },
          { id: 101, name: "Sirloin Steak" },
          { id: 102, name: "Filet Mignon" },
          { id: 103, name: "New York Strip" },
          { id: 104, name: "T-Bone / Porterhouse" },
          { id: 105, name: "Flank Steak" },
          { id: 120, name: "Prime Rib Roast" },
          { id: 130, name: "Chuck Roast" },
          { id: 131, name: "Brisket" },
          { id: 140, name: "Beef Burger" },
        ]
      },
      pork: {
        name: "üê∑ Pork",
        cuts: [
          { id: 200, name: "Pork Chop" },
          { id: 201, name: "Pork Tenderloin" },
          { id: 210, name: "Pork Loin Roast" },
          { id: 211, name: "Pork Shoulder" },
          { id: 220, name: "Baby Back Ribs" },
        ]
      },
      poultry: {
        name: "üçó Poultry",
        cuts: [
          { id: 300, name: "Whole Chicken" },
          { id: 310, name: "Chicken Breast" },
          { id: 320, name: "Chicken Thigh" },
          { id: 330, name: "Whole Turkey" },
          { id: 340, name: "Duck Breast" },
        ]
      },
      fish: {
        name: "üêü Fish & Seafood",
        cuts: [
          { id: 400, name: "Salmon Fillet" },
          { id: 410, name: "Tuna Steak" },
          { id: 420, name: "Cod Fillet" },
          { id: 430, name: "Shrimp" },
          { id: 431, name: "Lobster Tail" },
        ]
      },
      lamb: {
        name: "üêë Lamb",
        cuts: [
          { id: 500, name: "Leg of Lamb" },
          { id: 501, name: "Rack of Lamb" },
          { id: 510, name: "Lamb Chops" },
        ]
      }
    };

    const DONENESS_OPTIONS = [
      { value: "rare", name: "Rare", icon: "üî¥" },
      { value: "medium_rare", name: "Medium Rare", icon: "üü†" },
      { value: "medium", name: "Medium", icon: "üü°" },
      { value: "medium_well", name: "Medium Well", icon: "üü§" },
      { value: "well_done", name: "Well Done", icon: "‚ö™" },
      { value: "pulled", name: "Pulled", icon: "üçñ" },
    ];

    const COOKING_METHODS = [
      { value: "oven_roast", name: "Oven Roast" },
      { value: "oven_bake", name: "Oven Bake" },
      { value: "pan_sear", name: "Pan Sear" },
      { value: "pan_fry", name: "Pan Fry" },
      { value: "grill", name: "Grill" },
      { value: "smoker", name: "Smoker" },
      { value: "air_fryer", name: "Air Fryer" },
      { value: "sous_vide", name: "Sous Vide" },
      { value: "slow_cooker", name: "Slow Cooker" },
    ];

    class KitchenCookingPanel {
      constructor() {
        this.hass = null;
        this.entities = [];
        this.selectedEntity = null;
        this.selectedCategory = null;
        this.selectedCut = null;
        this.selectedDoneness = "medium_rare";
        this.selectedMethod = "oven_roast";
        this.refreshInterval = null;
        
        this.init();
      }
      
      async init() {
        // Wait for HASS to be available
        await this.waitForHass();
        this.findEntities();
        this.render();
        
        // Auto-refresh every 2 seconds
        this.refreshInterval = setInterval(() => {
          if (this.selectedEntity) {
            this.render();
          }
        }, 2000);
      }
      
      async waitForHass() {
        return new Promise((resolve) => {
          const check = () => {
            if (window.hassConnection) {
              window.hassConnection.then(conn => {
                conn.subscribeStates((states) => {
                  this.hass = { states };
                  resolve();
                });
              });
            } else {
              setTimeout(check, 100);
            }
          };
          check();
        });
      }
      
      findEntities() {
        if (!this.hass) return;
        
        this.entities = Object.keys(this.hass.states)
          .filter(id => id.startsWith('sensor.') && 
            id.includes('cooking_session'));
        
        if (this.entities.length === 1) {
          this.selectedEntity = this.entities[0];
        }
      }
      
      getState() {
        if (!this.selectedEntity || !this.hass) return null;
        return this.hass.states[this.selectedEntity];
      }
      
      async callService(service, data = {}) {
        try {
          const conn = await window.hassConnection;
          await conn.sendMessage({
            type: 'call_service',
            domain: 'kitchen_cooking_engine',
            service: service,
            service_data: {
              entity_id: this.selectedEntity,
              ...data
            }
          });
          setTimeout(() => this.render(), 500);
        } catch (err) {
          console.error('Service call failed:', err);
          alert('Service call failed: ' + err.message);
        }
      }
      
      render() {
        const app = document.getElementById('app');
        const state = this.getState();
        
        if (!this.selectedEntity) {
          app.innerHTML = this.renderEntitySelector();
        } else if (!state) {
          app.innerHTML = '<div class="error">Entity not found. Please check your configuration.</div>' + 
                          this.renderEntitySelector();
        } else if (state.state === 'idle') {
          app.innerHTML = this.renderSetupForm();
        } else {
          app.innerHTML = this.renderActiveCook(state);
        }
        
        this.attachEventListeners();
      }
      
      renderEntitySelector() {
        if (this.entities.length === 0) {
          return `
            <div class="card">
              <div class="error">
                No Kitchen Cooking Engine entities found. 
                Please configure the integration first.
              </div>
            </div>
          `;
        }
        
        return `
          <div class="entity-selector">
            <label>Select Cooking Session:</label>
            <select id="entity-select">
              <option value="">Choose entity...</option>
              ${this.entities.map(e => `
                <option value="${e}" ${this.selectedEntity === e ? 'selected' : ''}>
                  ${e}
                </option>
              `).join('')}
            </select>
          </div>
        `;
      }
      
      renderSetupForm() {
        return `
          <div class="status-banner idle">
            <h2>üç≥ Ready to Cook</h2>
            <p>Select your protein and preferences below</p>
          </div>
          
          <div class="card">
            <div class="card-title"><span class="icon">ü•©</span> Select Protein</div>
            <div class="button-group">
              ${Object.entries(CUTS_DATA).map(([key, cat]) => `
                <button class="category-btn ${this.selectedCategory === key ? 'selected' : ''}" 
                        data-category="${key}">${cat.name}</button>
              `).join('')}
            </div>
            
            ${this.selectedCategory ? `
              <div class="form-group" style="margin-top: 16px;">
                <label>Select Cut:</label>
                <select id="cut-select">
                  <option value="">Choose a cut...</option>
                  ${CUTS_DATA[this.selectedCategory].cuts.map(cut => `
                    <option value="${cut.id}" ${this.selectedCut === cut.id ? 'selected' : ''}>
                      ${cut.name}
                    </option>
                  `).join('')}
                </select>
              </div>
            ` : ''}
          </div>
          
          ${this.selectedCut ? `
            <div class="card">
              <div class="card-title"><span class="icon">üå°Ô∏è</span> Doneness Level</div>
              <div class="doneness-grid">
                ${DONENESS_OPTIONS.map(opt => `
                  <button class="doneness-btn ${this.selectedDoneness === opt.value ? 'selected' : ''}"
                          data-doneness="${opt.value}">
                    <span class="icon">${opt.icon}</span>
                    <span class="label">${opt.name}</span>
                  </button>
                `).join('')}
              </div>
            </div>
            
            <div class="card">
              <div class="card-title"><span class="icon">üç≥</span> Cooking Method</div>
              <div class="method-grid">
                ${COOKING_METHODS.map(opt => `
                  <button class="method-btn ${this.selectedMethod === opt.value ? 'selected' : ''}"
                          data-method="${opt.value}">
                    ${opt.name}
                  </button>
                `).join('')}
              </div>
            </div>
            
            <button class="action-button primary" id="start-cook">
              üî• Start Cooking
            </button>
          ` : ''}
        `;
      }
      
      renderActiveCook(state) {
        const attrs = state.attributes;
        const progress = attrs.progress || 0;
        const currentTemp = attrs.current_temp;
        const targetTemp = attrs.target_temp_c;
        const cut = attrs.cut_display || attrs.cut || "Unknown";
        const doneness = (attrs.doneness || "").replace("_", " ");
        const method = (attrs.cooking_method || "").replace("_", " ");
        const eta = attrs.eta_minutes;
        const cookState = state.state;
        
        return `
          <div class="status-banner ${cookState}">
            <h2>${this.getStateIcon(cookState)} ${cookState.replace("_", " ")}</h2>
            <p>${cut} ‚Ä¢ ${doneness}</p>
          </div>
          
          <div class="card">
            <div class="temp-display">
              <div>
                <div class="temp-current">${currentTemp !== null ? currentTemp + '¬∞C' : '--'}</div>
                <div style="color: var(--text-secondary);">Current Temperature</div>
              </div>
              <div style="text-align: right;">
                <div class="temp-target">${targetTemp}¬∞C</div>
                <div style="color: var(--text-secondary); font-size: 12px;">Target</div>
              </div>
            </div>
            
            <div class="progress-section">
              <div class="progress-bar-container">
                <div class="progress-bar ${cookState}" style="width: ${progress}%"></div>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 14px;">
                <span>${progress.toFixed(0)}% complete</span>
                ${eta !== null ? `<span>ETA: ${eta} min</span>` : ''}
              </div>
            </div>
            
            <div class="cook-info">
              <div class="cook-info-item">
                <div class="label">Method</div>
                <div class="value">${method}</div>
              </div>
              <div class="cook-info-item">
                <div class="label">Rest Time</div>
                <div class="value">${attrs.rest_time_minutes || '--'}</div>
              </div>
            </div>
            
            <div class="action-buttons">
              ${cookState === 'goal_reached' ? `
                <button class="action-button success" id="start-rest">
                  ‚è±Ô∏è Start Rest
                </button>
              ` : ''}
              ${cookState === 'resting' ? `
                <button class="action-button success" id="complete">
                  ‚úÖ Complete
                </button>
              ` : ''}
              <button class="action-button danger" id="stop-cook">
                ‚èπÔ∏è Stop Cook
              </button>
            </div>
          </div>
        `;
      }
      
      getStateIcon(state) {
        const icons = {
          idle: 'ü•©',
          cooking: 'üî•',
          approaching: '‚ö†Ô∏è',
          goal_reached: '‚úÖ',
          resting: '‚è±Ô∏è',
          complete: 'üçΩÔ∏è'
        };
        return icons[state] || 'üç≥';
      }
      
      attachEventListeners() {
        // Entity selector
        const entitySelect = document.getElementById('entity-select');
        if (entitySelect) {
          entitySelect.addEventListener('change', (e) => {
            this.selectedEntity = e.target.value || null;
            this.render();
          });
        }
        
        // Category buttons
        document.querySelectorAll('[data-category]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            this.selectedCategory = e.target.dataset.category;
            this.selectedCut = null;
            this.render();
          });
        });
        
        // Cut selector
        const cutSelect = document.getElementById('cut-select');
        if (cutSelect) {
          cutSelect.addEventListener('change', (e) => {
            this.selectedCut = parseInt(e.target.value) || null;
            this.render();
          });
        }
        
        // Doneness buttons
        document.querySelectorAll('[data-doneness]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            this.selectedDoneness = e.target.closest('[data-doneness]').dataset.doneness;
            this.render();
          });
        });
        
        // Method buttons
        document.querySelectorAll('[data-method]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            this.selectedMethod = e.target.closest('[data-method]').dataset.method;
            this.render();
          });
        });
        
        // Start cook
        const startBtn = document.getElementById('start-cook');
        if (startBtn) {
          startBtn.addEventListener('click', () => {
            this.callService('start_cook', {
              cut_id: this.selectedCut,
              doneness: this.selectedDoneness,
              cooking_method: this.selectedMethod
            });
          });
        }
        
        // Stop cook
        const stopBtn = document.getElementById('stop-cook');
        if (stopBtn) {
          stopBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to stop this cook?')) {
              this.callService('stop_cook');
            }
          });
        }
        
        // Start rest
        const restBtn = document.getElementById('start-rest');
        if (restBtn) {
          restBtn.addEventListener('click', () => {
            this.callService('start_rest');
          });
        }
        
        // Complete
        const completeBtn = document.getElementById('complete');
        if (completeBtn) {
          completeBtn.addEventListener('click', () => {
            this.callService('complete_session');
          });
        }
      }
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new KitchenCookingPanel();
    });
  </script>
</body>
</html>
