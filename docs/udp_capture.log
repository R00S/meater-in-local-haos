# UDP Capture Analysis - MEATER Link Protocol

This document contains tcpdump analysis showing the difference between the old simple packet format and the new protobuf format.

## Network Setup
- ESP32 IP: 192.168.1.178
- MEATER App IP: 192.168.1.217
- UDP Port: 7878 (MEATER_LINK_UDP_PORT)
- Protocol: UDP broadcast to x.x.x.255

## [OBSOLETE] Old Format (Simple 24-byte packet)

### Packet Structure
```
Offset | Length | Description
-------|--------|-------------
0      | 13     | Device name: "MEATER Block\0"
13     | 1      | Probe ID: 0x01
14     | 8      | Raw temperature data (from BLE characteristic)
22     | 2      | Raw battery data (from BLE characteristic)
```

### Example Hex Dump (24 bytes)
```
4d 45 41 54 45 52 20 42 6c 6f 63 6b 00 01
XX XX XX XX XX XX XX XX
YY YY
```

Where:
- `4d 45 41 54 45 52 20 42 6c 6f 63 6b 00` = "MEATER Block\0"
- `01` = Probe #1
- `XX XX XX XX XX XX XX XX` = 8 bytes temperature data
- `YY YY` = 2 bytes battery data

## [OBSOLETE] New Format (Protobuf MeaterLinkMessage with MasterMessage)

### MEATER App Broadcast Example (from tcpdump)

Source: 192.168.1.217:7878 → 192.168.1.255:7878

**Hex dump (79 bytes):**
```
0a 13 08 ca a8 01 10 11 18 07 20 03 29 47 d8 71 93 39 ac 16 6e
12 38 0a 10 4c 0b 82 35 23 a3 98 ea 38 6c a8 5e d2 48 6d 44 10 02
1a 0c 72 6f 6f 73 40 72 6f 6f 73 2e 74 63
22 09 54 43 4c 20 54 37 30 32 44
2a 05 34 2e 36 2e 33
32 02 31 34
```

### Correct Protocol Structure

**MeaterLinkMessage Structure:**
```
Field 1: MeaterLinkHeader (nested message)
Field 2: SubscriptionMessage (app → block) - not in broadcasts
Field 3: MasterMessage (block → app) - THIS IS WHAT BLOCKS SEND
Field 4: SetupMessage (app → block) - cook configuration
Field 5-15: Other message types
```

**MasterMessage Structure (Field 3):**
```
Field 1: masterType (varint) - MASTER_TYPE_BLOCK = 0
Field 2: cloudConnectionState (varint) - CLOUD_CONNECTION_STATE_DISABLED = 0
Field 3: devices (repeated MLDevice) - array of connected devices
```

**MLDevice Structure:**
```
Field 1: probe (MLProbe nested message)
  Field 1: parentIdentifier (fixed64) - device ID
  Field 3: setup (CookSetup nested message)
  Field 4: status (CookStatus nested message)
Field 5: identifier (fixed64) - device ID
Field 6: probeNumber (uint32) - 0-3 for block probes
Field 7: chargeState (ChargeState nested message)
Field 8: firmwareRevision (string) - "v1.0.6_0"
Field 9: connectionState (varint) - CONNECTION_STATE_CONNECTED = 1
Field 10: connectionType (varint) - BLE = 0
Field 11: bleSignalLevel (sint32) - RSSI value
Field 12: wifiSignalLevel (sint32) - optional
```

### Protobuf Field Breakdown (Corrected)

#### Field 1 (0a 13): MeaterLinkHeader - 19 bytes
```
0a          = Field 1, wire type 2 (length-delimited)
13          = Length: 19 bytes
  08 ca a8 01   = Field 1 (varint): timestamp_ms = 21,194
  10 11         = Field 2 (varint): sequence = 17
  18 07         = Field 3 (varint): version = 7
  20 03         = Field 4 (varint): unknown1 = 3
  29 47 d8 71 93 39 ac 16 6e  = Field 5 (fixed64): unknown2 = 0x47d87193396eac16
```

#### Field 2 (12 38): This is actually Field 3 MasterMessage - 56 bytes
**NOTE:** The captured packet appears to be a simplified discovery broadcast,
not the full MasterMessage structure. A proper Block would send:
```
Field 3: MasterMessage (length-delimited) {
  Field 1: masterType = 0 (MASTER_TYPE_BLOCK)
  Field 2: cloudConnectionState = 0 (DISABLED)
  Field 3: devices (repeated) {
    MLDevice nested message with all probe data
  }
}
```

### [OBSOLETE] What Our Implementation Sends

**NOTE:** This section describes an obsolete implementation that used Field 3 (MasterMessage).
The current implementation uses Field 2 (SubscriptionMessage) with custom structure.

We now send proper MeaterLinkMessage with nested MasterMessage:
```
MeaterLinkMessage {
  Field 1: MeaterLinkHeader {...}
  Field 3: MasterMessage {
    masterType: MASTER_TYPE_BLOCK (0)
    cloudConnectionState: CLOUD_CONNECTION_STATE_DISABLED (0)
    devices: [
      MLDevice {
        probe: MLProbe {
          parentIdentifier: device_id
          setup: CookSetup {...}
          status: CookStatus {temps, battery, ...}
        }
        identifier: device_id
        probeNumber: 0
        chargeState: ChargeState {...}
        connectionState: CONNECTED (1)
        connectionType: BLE (0)
        bleSignalLevel: -50
        firmwareRevision: "v1.0.6_0"
      }
    ]
  }
}
```

## Protobuf Wire Types

| Type | Name            | Used For                           |
|------|-----------------|------------------------------------|
| 0    | Varint          | int32, int64, uint32, uint64, bool |
| 1    | 64-bit          | fixed64, double                    |
| 2    | Length-delimited| string, bytes, embedded messages   |
| 3    | Start group     | (deprecated)                       |
| 4    | End group       | (deprecated)                       |
| 5    | 32-bit          | fixed32, float                     |

## [OBSOLETE] ESP32 Implementation

**NOTE:** This section describes an obsolete implementation.

Our implementation generates similar 79-byte packets with:
- Custom device_id derived from ESP32 MAC address
- Username: "meater@esp32.local"
- Device model: "ESP32-C3"
- App version: "4.6.3"
- Sequence number auto-incremented
- Timestamp in milliseconds from boot

## [OBSOLETE] Broadcast Timing

**NOTE:** This section describes obsolete implementation timing.

- **Old format**: Every 1 second
- **New format**: Every 5 seconds (matches MEATER app behavior)
- **Polling**: Every 100ms for incoming packets

## References

- Protocol research: https://github.com/nathanfaber/meaterble
- Protobuf encoding: https://developers.google.com/protocol-buffers/docs/encoding
