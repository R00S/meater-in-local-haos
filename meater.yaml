esphome:
  name: meater
  friendly_name: meater
  includes:
    - includes/meater_ble_server.h
  on_boot:
    priority: -10
    then:
      - lambda: |-
          // Initialize BLE server on boot for phone app connectivity
          if (id(meater_ble_server_ptr) == nullptr) {
            static MeaterBLEServer* server = new MeaterBLEServer();
            server->setup();
            id(meater_ble_server_ptr) = (void*)server;
            ESP_LOGI("meater", "NimBLE BLE server initialized");
          }

esp32:
  board: esp32-c6-devkitc-1
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_BT_ENABLED: y
      CONFIG_BT_NIMBLE_ENABLED: y
      CONFIG_BT_NIMBLE_ROLE_CENTRAL: y
      CONFIG_BT_NIMBLE_ROLE_PERIPHERAL: y
      CONFIG_BT_NIMBLE_MAX_CONNECTIONS: "4"
    components:
      - name: bt
        source: ~3.5.0

esp32_ble:
  max_connections: 4

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: !secret fallback_ap_ssid
    password: !secret fallback_ap_password

captive_portal:

# Configure BLE tracker for BLE client scanning
esp32_ble_tracker:
  scan_parameters:
    interval: 1100ms
    window: 1100ms
    active: true

ble_client:
  - mac_address: !secret meater_mac_address
    id: meater
    auto_connect: true

 
text_sensor:
  - platform: template
    name: "MEATER firmware"
    id: meater_firmware
  - platform: template
    name: "MEATER device name"
    id: meater_device_name_display
 
sensor:
  - platform: ble_client
    type: characteristic
    ble_client_id: meater
    name: "MEATER tip temperature"
    service_uuid: 'a75cc7fc-c956-488f-ac2a-2dbc08b63a04'
    characteristic_uuid: '7edda774-045e-4bbf-909b-45d1991a2876'
    icon: 'mdi:thermometer'
    unit_of_measurement: '°C'
    accuracy_decimals: 2
    notify: true
    lambda: |-
      // Forward raw data to BLE server for phone app (server initialized after device name read)
      if (id(meater_ble_server_ptr) != nullptr) {
        ((MeaterBLEServer*)id(meater_ble_server_ptr))->update_temp_data(x);
      }
      
      // Calculate temperature for Home Assistant (existing functionality)
      uint16_t tip_temp = (x[0] + (x[1] << 8) + 8.0) / 16.0;
      return (float)tip_temp;
  - platform: ble_client
    type: characteristic
    ble_client_id: meater
    name: "MEATER ambient temperature"
    service_uuid: 'a75cc7fc-c956-488f-ac2a-2dbc08b63a04'
    characteristic_uuid: '7edda774-045e-4bbf-909b-45d1991a2876'
    icon: 'mdi:thermometer'
    unit_of_measurement: '°C'
    accuracy_decimals: 2
    notify: true
    lambda: |-
      // Calculate ambient temperature for Home Assistant (existing functionality)
      uint16_t tip = x[0] + (x[1] << 8);
      uint16_t ra = x[2] + (x[3] << 8);
      uint16_t oa = x[4] + (x[5] << 8);
      uint16_t min_val = 48;
      uint16_t ambient = (tip + std::max(0, (((ra - std::min(min_val, oa)) * 16 * 589) / 1487)) + 8.0) / 16;
      return (float)ambient;
  - platform: ble_client
    type: characteristic
    ble_client_id: meater
    name: "MEATER battery level"
    service_uuid: 'a75cc7fc-c956-488f-ac2a-2dbc08b63a04'
    characteristic_uuid: '2adb4877-68d8-4884-bd3c-d83853bf27b8'
    icon: 'mdi:battery'
    unit_of_measurement: '%'
    notify: true
    lambda: |-
      // Forward raw data to BLE server for phone app
      if (id(meater_ble_server_ptr) != nullptr) {
        ((MeaterBLEServer*)id(meater_ble_server_ptr))->update_battery_data(x);
      }
      
      // Calculate battery percentage for Home Assistant (existing functionality)
      uint16_t battery = (x[0] + x[1]) * 10;
      return (float)battery;
  - platform: ble_client
    type: characteristic
    ble_client_id: meater
    id: firmware
    service_uuid: '180A'
    characteristic_uuid: '00002a26-0000-1000-8000-00805f9b34fb'
    lambda: |-
      // Update firmware text sensor (existing functionality)
      std::string data_string(x.begin(), x.end());
      id(meater_firmware).publish_state(data_string.c_str());
      
      // Forward firmware data to BLE server for phone app
      if (id(meater_ble_server_ptr) != nullptr) {
        ((MeaterBLEServer*)id(meater_ble_server_ptr))->update_firmware_data(x);
      }
      
      return (float)x.size();
  - platform: ble_client
    type: rssi
    ble_client_id: meater
    name: "MEATER RSSI"
  - platform: ble_client
    type: characteristic
    ble_client_id: meater
    id: meater_device_name_reader
    internal: true
    service_uuid: '1800'  # Generic Access Profile service
    characteristic_uuid: '2A00'  # Device Name characteristic
    lambda: |-
      // Read device name from real MEATER
      std::string device_name(x.begin(), x.end());
      ESP_LOGI("meater", "Read device name from real MEATER: %s", device_name.c_str());
      
      // Update text sensor
      id(meater_device_name_display).publish_state(device_name);
      
      // Initialize BLE server with device name (only once after name is read)
      static bool ble_server_initialized = false;
      if (!ble_server_initialized && id(meater_ble_server_ptr) == nullptr) {
        ESP_LOGI("meater", "Initializing BLE server with device name: %s", device_name.c_str());
        static MeaterBLEServer* ble_server = new MeaterBLEServer();
        ble_server->set_device_name(device_name);  // Set name BEFORE setup
        ble_server->setup();  // Start advertising with correct name
        id(meater_ble_server_ptr) = (void*)ble_server;
        ble_server_initialized = true;
      }
      
      return (float)x.size();

# Global variable to store the BLE server instance
globals:
  - id: meater_ble_server_ptr
    type: void*
    restore_value: no
    initial_value: 'nullptr'
